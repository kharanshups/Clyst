<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Community Feed</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" charset="UTF-8" href="https://www.gstatic.com/_/translate_http/_/ss/k=translate_http.tr.pgV-E-68K-A.L.W.O/am=gMA/d=0/rs=AN8SPfpszKJssl6IA0boGClFdsaAZGtXEQ/m=el_main_css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/_/translate_http/_/js/k=translate_http.tr.en_GB.m9XUR-6KYdw.O/am=AAAE/d=1/exm=el_conf/ed=1/rs=AN8SPfpiUZ3tTuF6ph1C-fs0MeesXfP2TQ/m=el_main"></script></head>
  
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/index.css" />
    <style>
      /* Hide comments and reply forms until user clicks Reply */
      
    </style>
    </head>
  <body data-auth="{{ current_user.is_authenticated|tojson }}" data-login-url="{{ url_for('login')|e }}">
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
      <div class="nav-left">
        <div class="hamburger" onclick="toggleMenu(event)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path></svg>
        </div>
        <a
          href="{{ url_for('home') }}"
          >Clyst</a
        >
      </div>

      <div class="nav-center" id="navLinks">
        <a href="{{ url_for('home') }}" class="nav-active">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>

      <div class="search-box" id="searchBox">
        <input
          id="quickSearchInput"
          type="text"
          placeholder="Search..."
          value="{{ q or '' }}"
        />
      </div>

      <div class="nav-actions">
        <div
          class="search-icon"
          onclick="toggleSearch()"
          aria-label="Open search"
          title="Search"
        >
          <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="m18,10c0-4.41-3.59-8-8-8S2,5.59,2,10s3.59,8,8,8c1.85,0,3.54-.63,4.9-1.69l5.1,5.1,1.41-1.41-5.1-5.1c1.05-1.36,1.69-3.05,1.69-4.9Zm-14,0c0-3.31,2.69-6,6-6s6,2.69,6,6-2.69,6-6,6-6-2.69-6-6Z"></path>
</svg>
        </div>
        {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('view_cart') }}"
            class="cart-btn"
            title="Shopping Cart"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"
              ></path>
            </svg><span class="cart-count" id="cartCount">0</span>
          </a>
          <a
            href="{{ url_for('profile') }}"
            class="profile-btn"
            title="Profile"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"
              />
            </svg>
          </a>
          {% endif %}
      </div>
      </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="{{ url_for('home') }}" class="nav-active">Community Feed</a>
      <a href="{{ url_for('products_page') }}">Marketplace</a>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('logout') }}">Logout</a>
      {% else %}
      <a href="{{ url_for('login') }}">Login</a>
      <a href="{{ url_for('register') }}">Register</a>
      {% endif %}
    </div>
    </nav>


    <div class="container">
      <div class="header">
        <h1>Community Feed</h1>
      </div>

    <!-- ===== SEARCH BELOW NAV ===== -->
    <div id="searchBelow" class="search-below">
      <div class="search-pill">
        <input
          id="globalSearchInput"
          type="text"
          placeholder="Find your trend"
          value="{{ q or '' }}"
        />
        <div class="search-close" onclick="toggleSearch()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="inherit"><path d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"></path></svg>
        </div>
      </div>
    </div>
      <!-- Main Content -->
      <div class="main-content">
        {% if posts %} {% for post in posts %}
  <div class="post-card" id="post-{{ post.post_id }}">
          <div class="post-header">
            <div class="user-info">
            <a href="{{ url_for('view_profile', user_id=post.artist_id) }}" class="post-avatar-link" style="text-decoration:none;">
              <div class="post-avatar">
                {{ post.artist.name[0].upper() }}
              </div>
            </a>
            <div class="post-user-info">
              <a
                href="{{ url_for('view_profile', user_id=post.artist_id) }}"
                class="post-username"
              >
                {{ post.artist.name }}
                {% if post.artist.is_verified %}
                &nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" fill="inherit" viewBox="0 0 256 256"><path d="M225.86,102.82c-3.77-3.94-7.67-8-9.14-11.57-1.36-3.27-1.44-8.69-1.52-13.94-.15-9.76-.31-20.82-8-28.51s-18.75-7.85-28.51-8c-5.25-.08-10.67-.16-13.94-1.52-3.56-1.47-7.63-5.37-11.57-9.14C146.28,23.51,138.44,16,128,16s-18.27,7.51-25.18,14.14c-3.94,3.77-8,7.67-11.57,9.14C88,40.64,82.56,40.72,77.31,40.8c-9.76.15-20.82.31-28.51,8S41,67.55,40.8,77.31c-.08,5.25-.16,10.67-1.52,13.94-1.47,3.56-5.37,7.63-9.14,11.57C23.51,109.72,16,117.56,16,128s7.51,18.27,14.14,25.18c3.77,3.94,7.67,8,9.14,11.57,1.36,3.27,1.44,8.69,1.52,13.94.15,9.76.31,20.82,8,28.51s18.75,7.85,28.51,8c5.25.08,10.67.16,13.94,1.52,3.56,1.47,7.63,5.37,11.57,9.14C109.72,232.49,117.56,240,128,240s18.27-7.51,25.18-14.14c3.94-3.77,8-7.67,11.57-9.14,3.27-1.36,8.69-1.44,13.94-1.52,9.76-.15,20.82-.31,28.51-8s7.85-18.75,8-28.51c.08-5.25.16-10.67,1.52-13.94,1.47-3.56,5.37-7.63,9.14-11.57C232.49,146.28,240,138.44,240,128S232.49,109.73,225.86,102.82Zm-52.2,6.84-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"></path></svg>
                {% endif %}
              </a>
              
              <div class="post-time">{{ post.created_at }} &#0149; {{ comment_count }} comment{{ 's' if comment_count != 1 else '' }}</div>
              
             
            </div> 
          </div>
              {% if current_user.is_authenticated and current_user.id == post.artist_id %}
              <div class="post-actions">
                <a class="action-btn delete-btn" href="{{ url_for('delete_posts', post_id=post.post_id) }}" onclick="return confirm('Delete this post?')">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M17 6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6ZM9 11V17H11V11H9ZM13 11V17H15V11H13ZM9 4V6H15V4H9Z"></path></svg>
                </a>
              </div>
              {% endif %}
            
          </div>

          <div class="post-content">
            {% if post.is_promoted %}
            <div class="promoted-tag">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.007 2.10377C8.60544 1.65006 7.08181 2.28116 6.41156 3.59306L5.60578 5.17023C5.51004 5.35763 5.35763 5.51004 5.17023 5.60578L3.59306 6.41156C2.28116 7.08181 1.65006 8.60544 2.10377 10.007L2.64923 11.692C2.71404 11.8922 2.71404 12.1078 2.64923 12.308L2.10377 13.993C1.65006 15.3946 2.28116 16.9182 3.59306 17.5885L5.17023 18.3942C5.35763 18.49 5.51004 18.6424 5.60578 18.8298L6.41156 20.407C7.08181 21.7189 8.60544 22.35 10.007 21.8963L11.692 21.3508C11.8922 21.286 12.1078 21.286 12.308 21.3508L13.993 21.8963C15.3946 22.35 16.9182 21.7189 17.5885 20.407L18.3942 18.8298C18.49 18.6424 18.6424 18.49 18.8298 18.3942L20.407 17.5885C21.7189 16.9182 22.35 15.3946 21.8963 13.993L21.3508 12.308C21.286 12.1078 21.286 11.8922 21.3508 11.692L21.8963 10.007C22.35 8.60544 21.7189 7.08181 20.407 6.41156L18.8298 5.60578C18.6424 5.51004 18.49 5.35763 18.3942 5.17023L17.5885 3.59306C16.9182 2.28116 15.3946 1.65006 13.993 2.10377L12.308 2.64923C12.1078 2.71403 11.8922 2.71404 11.692 2.64923L10.007 2.10377ZM6.75977 11.7573L8.17399 10.343L11.0024 13.1715L16.6593 7.51465L18.0735 8.92886L11.0024 15.9999L6.75977 11.7573Z"></path></svg>
              &nbsp; Promoted
            </div>
            {% endif %}
            <div class="title">
              <h3 class="post-title">{{ post.post_title }}</h3>
            {% if current_user.is_authenticated and current_user.id == post.artist_id %}
                <button type="button" class="action-btn edit-btn" onclick="openEditPostModal('{{ post.post_id }}', '{{ post.post_title | replace("'", "\\'") }}', '{{ post.description | replace("'", "\\'") }}', '{{ post.media_url }}', {{ post.is_promoted | lower }})">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M15.7279 9.57627L14.3137 8.16206L5 17.4758V18.89H6.41421L15.7279 9.57627ZM17.1421 8.16206L18.5563 6.74785L17.1421 5.33363L15.7279 6.74785L17.1421 8.16206ZM7.24264 20.89H3V16.6474L16.435 3.21233C16.8256 2.82181 17.4587 2.82181 17.8492 3.21233L20.6777 6.04075C21.0682 6.43128 21.0682 7.06444 20.6777 7.45497L7.24264 20.89Z"></path></svg>
                </button>
              {% endif %}
            </div>
            <p class="post-description">{{ post.description|safe }}</p>
          </div>

          {% if post.media_url %}
          <img
            src="{{ post.media_url }}"
            alt="{{ post.post_title }}"
            class="post-image"
          />
          {% endif %}

          <div class="post-footer">
              {% set comment_count = post.comments|length if post.comments else 0 %} 
          <div class="icon-set">
            <button class="icons LikeBtn" data-post-id="{{ post.post_id }}" onclick="toggleLike(this)">
              <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="M4 21h1V8H4c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2M20 8h-6.61l1.12-3.37c.2-.61.1-1.28-.27-1.8-.38-.52-.98-.83-1.62-.83h-.61c-.3 0-.58.13-.77.36L7.01 7.44V21h10.31a2 2 0 0 0 1.87-1.3l2.76-7.35c.04-.11.06-.23.06-.35v-2c0-1.1-.9-2-2-2Z"></path>
</svg>
<span class="like-text">Like</span>
              <span class="like-count">0</span>
            </button>
            <button class="icons CommentBtn" data-post-id="{{ post.post_id }}" onclick="toggleComments(this)">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.45455 19L2 22.5V4C2 3.44772 2.44772 3 3 3H21C21.5523 3 22 3.44772 22 4V18C22 18.5523 21.5523 19 21 19H6.45455Z"></path></svg>
              &nbsp;Comment
            </button>
            <button class="icons ShareBtn"
                data-url="{{ url_for('home') }}"
                data-title="{{ post.post_title|e }}"
                data-artist="{{ post.artist.name|e }}"
                onclick="sharePost(this)">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5759 17.2714L8.46576 14.484C7.83312 15.112 6.96187 15.5 6 15.5C4.067 15.5 2.5 13.933 2.5 12C2.5 10.067 4.067 8.5 6 8.5C6.96181 8.5 7.83301 8.88796 8.46564 9.51593L13.5759 6.72855C13.5262 6.49354 13.5 6.24983 13.5 6C13.5 4.067 15.067 2.5 17 2.5C18.933 2.5 20.5 4.067 20.5 6C20.5 7.933 18.933 9.5 17 9.5C16.0381 9.5 15.1669 9.11201 14.5343 8.48399L9.42404 11.2713C9.47382 11.5064 9.5 11.7501 9.5 12C9.5 12.2498 9.47383 12.4935 9.42408 12.7285L14.5343 15.516C15.167 14.888 16.0382 14.5 17 14.5C18.933 14.5 20.5 16.067 20.5 18C20.5 19.933 18.933 21.5 17 21.5C15.067 21.5 13.5 19.933 13.5 18C13.5 17.7502 13.5262 17.5064 13.5759 17.2714Z"></path></svg>&nbsp;Share
            </button>
          </div>
          <button class="speaker-btn" onclick="toggleSpeech(this, '{{ post.post_title|e }}', '{{ post.artist.name|e }}', '{{ post.description|e }}')">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
          </button>
          </div>
          {% if current_user.is_authenticated %}
          <form class="comment-section" action="{{ url_for('add_comments', post_id=post.post_id) }}" method="POST">
            <input type="hidden" name="anchor" value="post-{{ post.post_id }}" />
            <div class="post-avatar">{{ current_user.name[0].upper() }}</div>
            <input type="text" placeholder="Share your thoughts" name="comment" id="comment-{{ post.post_id }}" required />
            <button class="send-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12.9999H9V10.9999H3V1.84558C3 1.56944 3.22386 1.34558 3.5 1.34558C3.58425 1.34558 3.66714 1.36687 3.74096 1.40747L22.2034 11.5618C22.4454 11.6949 22.5337 11.9989 22.4006 12.2409C22.3549 12.324 22.2865 12.3924 22.2034 12.4381L3.74096 22.5924C3.499 22.7255 3.19497 22.6372 3.06189 22.3953C3.02129 22.3214 3 22.2386 3 22.1543V12.9999Z"></path></svg>
          </button>
          </form>
          {% else %}
          <!-- For guests, allow opening comments and prompt login to reply -->
          <form class="comment-section" action="{{ url_for('login') }}" method="GET">
            <button class="btn btn-primary">Login to comment</button>
          </form>
          {% endif %}
          <div class="comments-container" id="comments-{{ post.post_id }}">
          {% if post.comments %}
            {% for comment in post.comments %}
              <div class="comments">
                <div class="user-id-info">
                  <div class="user-info">
                  <div class="post-avatar">{{ comment.artist.name[0].upper() if comment.artist.name else 'U' }}</div>
                  <div class="artist-name">
                    {% if comment.artist.id %}
                      <a href="{{ url_for('view_profile', user_id=comment.artist.id) }}" class="post-username">{{ comment.artist.name }}</a>
                    {% else %}
                      <span class="post-username">{{ comment.artist.name }}</span>
                    {% endif %}
                    <p class="post-user-email">{{ comment.artist.email }} &#0149; {{ comment.created_at }}</p>
                  </div>
                </div>
                  {% if current_user.is_authenticated and current_user.id == comment.artist.id %}
                  <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" style="display:inline;margin-left:8px;">
                    <input type="hidden" name="anchor" value="post-{{ post.post_id }}" />
                    <button class="action-btn delete-btn" onclick="return confirm('Delete this comment?')">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M17 6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6ZM9 11V17H11V11H9ZM13 11V17H15V11H13ZM9 4V6H15V4H9Z"></path></svg>
                    </button>
                  </form>
                  {% endif %}
                  <button class="speaker-btn comment-speaker" onclick="toggleCommentSpeech(this, '{{ comment.content|e }}', '{{ comment.artist.name|e }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                  </button>
                </div>
                <p class="comment-p">{{ comment.content }}</p>
                <div class="icon-set comment-icons">
                  <button class="icons LikeBtn" data-post-id="{{ post.post_id }}" onclick="toggleLike(this)">
              <svg  xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="M4 21h1V8H4c-1.1 0-2 .9-2 2v9c0 1.1.9 2 2 2M20 8h-6.61l1.12-3.37c.2-.61.1-1.28-.27-1.8-.38-.52-.98-.83-1.62-.83h-.61c-.3 0-.58.13-.77.36L7.01 7.44V21h10.31a2 2 0 0 0 1.87-1.3l2.76-7.35c.04-.11.06-.23.06-.35v-2c0-1.1-.9-2-2-2Z"></path>
</svg><span class="like-text">Like</span>
              <span class="like-count">0</span>
            </button>

                </div>
              </div>
            {% endfor %}
          {% endif %}
          </div>
<!--          Must add like and comments functionality to posts and ratings & add to cart to products-->
        </div>

        {% endfor %} {% else %}
        <div class="empty-state">
          {% if current_user.is_authenticated %}
          <h3>POST TO START</h3>
          <p>Be the first to share your artwork with the community</p>
        <a
          href="{{ url_for('add_posts') }}"
          class="btn btn-primary"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg> START POSTING
        </a>
          {% else %}
          <h3>NO POSTS AVAILABLE</h3>
          <p>Login to post</p>
          {% endif %}
        </div>
        {% if current_user.is_authenticated %}
        {% endif %} {% endif %}
      </div>
    </div>

    <div id="google_translate_element" class="translate-element"></div>

    <button
      id="translateButton"
      onclick="googleTranslateElementInit()"
      class="translate-btn"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 10L22.9 21H20.745L19.544 18H15.454L14.255 21H12.101L16.5 10H18.5ZM10 2V4H16V6L14.0322 6.0006C13.2425 8.36616 11.9988 10.5057 10.4115 12.301C11.1344 12.9457 11.917 13.5176 12.7475 14.0079L11.9969 15.8855C10.9237 15.2781 9.91944 14.5524 8.99961 13.7249C7.21403 15.332 5.10914 16.5553 2.79891 17.2734L2.26257 15.3442C4.2385 14.7203 6.04543 13.6737 7.59042 12.3021C6.46277 11.0281 5.50873 9.57985 4.76742 8.00028L7.00684 8.00037C7.57018 9.03885 8.23979 10.0033 8.99967 10.877C10.2283 9.46508 11.2205 7.81616 11.9095 6.00101L2 6V4H8V2H10ZM17.5 12.8852L16.253 16H18.745L17.5 12.8852Z"></path></svg>
    </button>

    {% if current_user.is_authenticated %}
    <a href="{{ url_for('add_posts') }}" class="fab"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg></a>
    {% endif %}

    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <script>


      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      function toggleSearch() {
        const bar = document.getElementById("searchBelow");
        bar.classList.toggle("open");
        const menu = document.getElementById("mobileMenu");
        if (menu.style.display === "flex") menu.style.display = "none";
        if (bar.classList.contains("open")) {
          requestAnimationFrame(() =>
            document.getElementById("globalSearchInput").focus()
          );
        }
      }

      // Highlight active nav link
      document.addEventListener("DOMContentLoaded", function () {
        const path = window.location.pathname.split("/").pop();
        document
          .querySelectorAll(".nav-center a, .mobile-menu a")
          .forEach((link) => {
            if (link.getAttribute("href") === path) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });

          // Initialize like buttons: fetch current counts and liked state
          document.querySelectorAll('.LikeBtn[data-post-id]').forEach(btn => {
            const postId = btn.getAttribute('data-post-id');
            fetch(`/api/post/${postId}/likes`).then(r => r.json()).then(data => {
              const countEl = btn.querySelector('.like-count');
              if (data.count && data.count > 0) {
                countEl.textContent = `${data.count}`;
                btn.querySelector('.like-text').textContent = '';
              } else {
                countEl.textContent = '';
                btn.querySelector('.like-text').textContent = ' Like';
              }
              if (data.liked) btn.classList.add('liked');
            }).catch(() => {});
          });

        // Submit search to posts page by default
        const global = document.getElementById("globalSearchInput");
        if (global) {
          global.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = global.value.trim();
              const url = new URL(window.location.origin + "/");
              if (q) url.searchParams.set("q", q);
              window.location.href = url.toString();
            }
          });
        }

        const quick = document.getElementById("quickSearchInput");
        if (quick) {
          quick.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = quick.value.trim();
              const url = new URL(window.location.origin + "/");
              if (q) url.searchParams.set("q", q);
              window.location.href = url.toString();
            }
          });
        }
      });

      function copy() {
        const textElement = document.getElementById("myText");
        if (textElement) {
          const textContent = textElement.innerText;
          copyToClipboard(textContent);
        }
      }
      async function copyToClipboard(textToCopy) {
        try {
          await navigator.clipboard.writeText(textToCopy);
          alert("Link copied to clipboard");
        } catch (err) {
          alert("Failed to copy link: " + err);
        }
      }
    </script>
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en", // Set your website's default language
            includedLanguages:
              "en,hi,bi,ta,te,mr,gu,kn,ml,pa,ur,es,fr,de,zh,ja,ko", // Optional: Specify languages to include in the dropdown
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, // Optional: Customize widget layout
          },
          "google_translate_element"
        );
      }
      async function copyToClipboard(textToCopy) {
        try {
          await navigator.clipboard.writeText(textToCopy);
          alert("Link copied to clipboard");
        } catch (err) {
          alert("Failed to copy text: " + err);
        }
      }
      // Helper to construct a share URL and copy it
      function sharePost(el) {
        const path = el.getAttribute('data-url') || '/';
        const title = el.getAttribute('data-title') || '';
        const artist = el.getAttribute('data-artist') || '';
        const q = encodeURIComponent(title + ' ' + artist);
        const full = window.location.origin + path + '?q=' + q;
        if (window.openShareModal) return openShareModal(full, title, artist ? `By ${artist}` : '');
        copyToClipboard(full);
      }

      // Toggle like via API
      async function toggleLike(btn) {
        const postId = btn.getAttribute('data-post-id');
        if (!postId) return;
        // If not logged in, redirect to login (simple UX)
        const body = document.body;
        const isAuth = body.dataset.auth === 'true';
        const loginUrl = body.dataset.loginUrl || '/login';
        if (!isAuth) {
          window.location.href = loginUrl;
          return;
        }

        try {
          const res = await fetch(`/api/post/${postId}/like`, {method: 'POST', headers: {'Content-Type':'application/json'}});
          if (!res.ok) throw new Error('Network');
          const data = await res.json();
          const countEl = btn.querySelector('.like-count');
          if (data.count && data.count > 0) {
            countEl.textContent = ` ${data.count}`;
            btn.querySelector('.like-text').textContent = '';
          } else {
            countEl.textContent = '';
            btn.querySelector('.like-text').textContent = ' Like';
          }
          if (data.liked) btn.classList.add('liked'); else btn.classList.remove('liked');
        } catch (err) {
          console.error(err);
        }
      }

      // Toggle comments visibility for a specific post
      function toggleComments(btn) {
        const postId = btn.getAttribute('data-post-id');
        if (!postId) return;
        const commentsEl = document.getElementById('comments-' + postId);
        const formEl = document.querySelector(`form.comment-section[action*="/comment/${postId}"]`);
        if (commentsEl) commentsEl.classList.toggle('open');
        if (formEl) formEl.classList.toggle('open');
        // Scroll into view when opening
        if (commentsEl && commentsEl.classList.contains('open')) {
          commentsEl.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
      }

      // Cart functionality
      async function addToCart(productId) {
        const button = document.querySelector(
          `[data-product-id="${productId}"]`
        );
        const originalText = button.innerHTML;

        // Show loading state
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div> Adding...';

        try {
          const response = await fetch(`/cart/add/${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            showCartMessage("Product added to cart!", "success");
            // Update cart count
            updateCartCount();
            // Reset button
            button.innerHTML = "âœ“ Added to Cart";
            button.style.background = "#28a745";
            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = "";
              button.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.message || "Failed to add to cart");
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showCartMessage("Failed to add to cart", "error");
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      async function updateCartCount() {
        try {
          const response = await fetch("/api/cart/count");
          const data = await response.json();
          document.getElementById("cartCount").textContent = data.count;
        } catch (error) {
          console.error("Error updating cart count:", error);
        }
      }

      function showCartMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".cart-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        // Create new message
        const messageEl = document.createElement("div");
        messageEl.className = `cart-message ${type}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        // Show message
        setTimeout(() => messageEl.classList.add("show"), 100);

        // Hide message after 3 seconds
        setTimeout(() => {
          messageEl.classList.remove("show");
          setTimeout(() => messageEl.remove(), 300);
        }, 3000);
      }

      // Update cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
      });

      // Edit post modal functionality
      function openEditPostModal(postId, title, description, mediaUrl, isPromoted) {
        // Create modal HTML
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'editPostModal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>Edit Post</h2>
              <button type="button" class="close-btn" onclick="closeEditPostModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"></path></svg>
              </button>
            </div>
            <form id="editPostForm" action="/add_posts" method="POST" enctype="multipart/form-data">
              <input type="hidden" name="post_id" value="${postId}">
              <div class="form-group">
                <label for="post_title">Post Title</label>
                <input type="text" id="post_title" name="post_title" value="${title}" required>
              </div>
              <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" required>${description}</textarea>
              </div>
              <div class="form-group">
                <label for="media">Image (leave empty to keep current)</label>
                <input type="file" id="media" name="media" accept="image/*">
                ${mediaUrl ? `<img src="${mediaUrl}" alt="Current image" class="preview-image">` : ''}
              </div>
              <div class="modal-footer">
                <button type="button" onclick="closeEditPostModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        `;

        // Add modal to page
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Show modal with animation
        setTimeout(() => modal.classList.add('open'), 10);

        // Setup form submission
        const form = document.getElementById('editPostForm');
        form.onsubmit = async (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          
          try {
            const response = await fetch("{{ url_for('add_posts') }}", {
              method: 'POST',
              body: formData
            });
            
            if (response.ok) {
              window.location.reload();
            } else {
              throw new Error('Failed to update post');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Failed to update post. Please try again.');
          }
        };
      }

      function closeEditPostModal() {
        const modal = document.getElementById('editPostModal');
        modal.classList.remove('open');
        setTimeout(() => {
          modal.remove();
          document.body.style.overflow = '';
        }, 300);
      }
    </script>

    <style>
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal.open {
        opacity: 1;
      }

      .modal-content {
        background: var(--card);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 2px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .modal.open .modal-content {
        transform: translateY(0);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .modal-header h2 {
        color: var(--text);
      }

      .close-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: var(--muted);
        transition: all 0.2s;
        border-radius: 2px;
      }

      .close-btn:hover {
        color: var(--accent);
        background: var(--bg);
      }

      .close-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text);
        font-weight: 500;
      }

      .form-group input[type="text"],
      .form-group textarea,
      .form-group input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 2px;
        background: var(--bg);
        color: var(--text);
        font-family: inherit;
        transition: border-color 0.2s;
      }

      .form-group input[type="text"]:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.1);
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .preview-image {
        max-width: 100%;
        height: auto;
        margin-top: 10px;
        border-radius: 2px;
        border: 1px solid var(--border);
      }

      .modal-footer {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
    </style>
    <script src="../static/js/app.js"></script>

    <script>
    // Speech synthesis variables
    let currentUtterance = null;
    let isPlaying = false;

    // Toggle speech for posts
    function toggleSpeech(button, title, artist, description) {
        if (isPlaying && currentUtterance) {
            // Stop speech
            speechSynthesis.cancel();
            isPlaying = false;
            currentUtterance = null;
            button.classList.remove('playing');
        } else {
            // Stop any existing speech first
            speechSynthesis.cancel();
            
            // Start new speech
            const textToSpeak = "Post by " + artist + ". " + title + ". " + description;
            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            
            currentUtterance.onstart = function() {
                isPlaying = true;
                button.classList.add('playing');
            };
            
            currentUtterance.onend = function() {
                isPlaying = false;
                currentUtterance = null;
                button.classList.remove('playing');
            };
            
            speechSynthesis.speak(currentUtterance);
        }
    }

    // Toggle speech for comments
    function toggleCommentSpeech(button, commentText, userName) {
        if (isPlaying && currentUtterance) {
            // Stop speech
            speechSynthesis.cancel();
            isPlaying = false;
            currentUtterance = null;
            button.classList.remove('playing');
        } else {
            // Stop any existing speech first
            speechSynthesis.cancel();
            
            // Start new speech
            const textToSpeak = "Comment by " + userName + ". " + commentText;
            currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
            
            currentUtterance.onstart = function() {
                isPlaying = true;
                button.classList.add('playing');
            };
            
            currentUtterance.onend = function() {
                isPlaying = false;
                currentUtterance = null;
                button.classList.remove('playing');
            };
            
            speechSynthesis.speak(currentUtterance);
        }
    }
    </script>
  </body>
</html>
