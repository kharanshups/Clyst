<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clyst - Marketplace</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <link rel="stylesheet" href="../static/css/products.css" />
  </head>
  <body>
    <!-- ===== NAVBAR ===== -->
    <nav id="topNav">
      <div class="nav">
        <div class="nav-left">
          <div class="hamburger" onclick="toggleMenu(event)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path d="M3 4H21V6H3V4ZM3 11H21V13H3V11ZM3 18H21V20H3V18Z"></path>
            </svg>
          </div>
          <a href="{{ url_for('home') }}">Clyst</a>
        </div>

        <div class="nav-center" id="navLinks">
          <a href="{{ url_for('home') }}">Community Feed</a>
          <a href="{{ url_for('products_page') }}">Marketplace</a>
          {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          <a href="{{ url_for('register') }}">Register</a>
          {% endif %}
        </div>

        <div class="nav-actions">
          <div
            class="search-icon"
            onclick="toggleSearch()"
            aria-label="Open search"
            title="Search"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
              <path
                d="m18,10c0-4.41-3.59-8-8-8S2,5.59,2,10s3.59,8,8,8c1.85,0,3.54-.63,4.9-1.69l5.1,5.1,1.41-1.41-5.1-5.1c1.05-1.36,1.69-3.05,1.69-4.9Zm-14,0c0-3.31,2.69-6,6-6s6,2.69,6,6-2.69,6-6,6-6-2.69-6-6Z"
              ></path>
            </svg>
          </div>
          {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('view_cart') }}"
            class="cart-btn"
            title="Shopping Cart"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M4.00436 6.41686L0.761719 3.17422L2.17593 1.76001L5.41857 5.00265H20.6603C21.2126 5.00265 21.6603 5.45037 21.6603 6.00265C21.6603 6.09997 21.6461 6.19678 21.6182 6.29L19.2182 14.29C19.0913 14.713 18.7019 15.0027 18.2603 15.0027H6.00436V17.0027H17.0044V19.0027H5.00436C4.45207 19.0027 4.00436 18.5549 4.00436 18.0027V6.41686ZM5.50436 23.0027C4.67593 23.0027 4.00436 22.3311 4.00436 21.5027C4.00436 20.6742 4.67593 20.0027 5.50436 20.0027C6.33279 20.0027 7.00436 20.6742 7.00436 21.5027C7.00436 22.3311 6.33279 23.0027 5.50436 23.0027ZM17.5044 23.0027C16.6759 23.0027 16.0044 22.3311 16.0044 21.5027C16.0044 20.6742 16.6759 20.0027 17.5044 20.0027C18.3328 20.0027 19.0044 20.6742 19.0044 21.5027C19.0044 22.3311 18.3328 23.0027 17.5044 23.0027Z"
              ></path>
            </svg>
            <span class="cart-count" id="cartCount">0</span>
          </a>
          <a
            href="{{ url_for('profile') }}"
            class="profile-btn"
            title="Profile"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"
              />
            </svg>
          </a>
          {% endif %}
        </div>
      </div>

      <div class="mobile-menu" id="mobileMenu">
        <a href="{{ url_for('home') }}">Community Feed</a>
        <a href="{{ url_for('products_page') }}">Marketplace</a>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('logout') }}">Logout</a>
        {% else %}
        <a href="{{ url_for('login') }}">Login</a>
        <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>Marketplace</h1>
      </div>
      <!-- ===== SEARCH BELOW NAV ===== -->
      <div id="searchBelow" class="search-below">
        <div class="search-pill">
          <input
            id="globalSearchInput"
            type="text"
            placeholder="Find your product"
            value="{{ q or '' }}"
          />
          <div class="search-close" onclick="toggleSearch()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="inherit"
            >
              <path
                d="M11.9997 10.5865L16.9495 5.63672L18.3637 7.05093L13.4139 12.0007L18.3637 16.9504L16.9495 18.3646L11.9997 13.4149L7.04996 18.3646L5.63574 16.9504L10.5855 12.0007L5.63574 7.05093L7.04996 5.63672L11.9997 10.5865Z"
              ></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="main-content">
        <!-- ===== SORT OPTIONS ===== -->
        <div class="sort-wrapper">
          <label for="sort-select">Sort by</label></br>
          <select id="sort-select" onchange="handleSortChange(this.value)">
            <option value="newest" {{ 'selected' if sort_by == 'newest' else '' }}>Newest</option>
            <option value="popular" {{ 'selected' if sort_by == 'popular' else '' }}>Popular</option>
            <option value="price_low" {{ 'selected' if sort_by == 'price_low' else '' }}>Price: Low to High</option>
            <option value="price_high" {{ 'selected' if sort_by == 'price_high' else '' }}>Price: High to Low</option>
          </select>
        </div>
        {% if products %}
        <div class="products-grid">
          {% for product in products %}
          <div class="product-card" onclick='location.href = "{{ url_for('product_buy', product_id=product.product_id) }}";'>
            {% if product.img_url %}
            <img
              src="{{ product.img_url }}"
              alt="{{ product.title }}"
              class="product-image"
            />
            {% else %}
            <div class="product-image placeholder">
              <i class="fas fa-image"></i>
            </div>
            {% endif %}
            <div class="product-info">
            <div class="product-header">
              <div>
                <h3 class="product-title">{{ product.title }}</h3>
                <div class="product-artist">By {{ product.artist.name }}</div>
              </div>
              <div class="product-price">Rs.{{ product.price }}</div>
            </div>

            {% if product.description %}
            <p class="product-description">{{ product.description|safe }}</p>
            {% endif %}
                <div class="product-rating-small" title="Average rating">
                  {% set avg = (product.avg_rating or 0) %} {% for i in
                  range(1,6) %} {% if i <= avg|round(0, 'floor') %}
                  <svg
                    class="star-icon icon-14 star--filled"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                    />
                  </svg>
                  {% else %}
                  <svg
                    class="star-icon icon-14 star--empty"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.786 1.402 8.172L12 18.896l-7.336 3.872 1.402-8.172L.132 9.21l8.2-1.192z"
                    />
                  </svg>
                  {% endif %} {% endfor %}
                  <span class="rating-text-small"
                    >{{ '%.1f'|format(product.avg_rating or 0) }} &#0149; {{
                    product.reviews_count or 0 }}</span
                  >
                </div>

            <div class="product-actions">
              <div class="prod-btns">
              {% if current_user.is_authenticated and current_user.id !=
              product.artist_id %}
              <button
                class="btn btn-primary"
                onclick="addToCart({{ product.product_id }})"
                data-product-id="{{ product.product_id }}"
                title="Add to Cart"
                type="button"
              >
                Add to Cart
              </button>
              <a
                href="{{ url_for('view_profile', user_id=product.artist_id) }}"
                class="btn btn-secondary"
              >
                View Artist
              </a>
              {% elif current_user.id == product.artist_id %}
                
          <button
            class="btn btn-primary"
            onclick="location.href='{{ url_for('product_buy', product_id=product.product_id) }}'"
            title="Edit Product"
            type="button"
          >
            Edit
          </button>
          <button
            class="btn btn-secondary"
            onclick="if(confirm('Delete this product?')) window.location.href='{{ url_for('delete_posts', product_id=product.product_id) }}'"
            title="Delete Post"
          >
            Delete
          </button>
              {% else %}
              <button
                class="btn btn-primary"
                onclick="window.location.href='{{ url_for('login') }}?next={{ url_for('product_buy', product_id=product.product_id) }}'"
                title="Login to add to cart"
                type="button"
              >
                Add to Cart
              </button>
              <a
                href="{{ url_for('view_profile', user_id=product.artist_id) }}"
                class="btn btn-secondary"
              >
                View Artist
              </a>
              {% endif %}
              </div>
            </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          {% if current_user.is_authenticated %}
          <h3>Add Product to get started</h3>
          <p>Be the first to sell products and get started</p>
          <a href="{{ url_for('add_products') }}" class="btn btn-primary">
            Add Your First Product
          </a>
          {% else %}
          <h3>Products to be listed soon</h3>
          <p>Become an artist to add your product</p>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    {% if current_user.is_authenticated %}
    <a href="{{ url_for('add_products') }}" class="fab"
      ><svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg></a>
    {% endif %}

    <div id="google_translate_element" class="translate-element"></div>
    <button
      id="translateButton"
      onclick="googleTranslateElementInit()"
      class="translate-btn"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M18.5 10L22.9 21H20.745L19.544 18H15.454L14.255 21H12.101L16.5 10H18.5ZM10 2V4H16V6L14.0322 6.0006C13.2425 8.36616 11.9988 10.5057 10.4115 12.301C11.1344 12.9457 11.917 13.5176 12.7475 14.0079L11.9969 15.8855C10.9237 15.2781 9.91944 14.5524 8.99961 13.7249C7.21403 15.332 5.10914 16.5553 2.79891 17.2734L2.26257 15.3442C4.2385 14.7203 6.04543 13.6737 7.59042 12.3021C6.46277 11.0281 5.50873 9.57985 4.76742 8.00028L7.00684 8.00037C7.57018 9.03885 8.23979 10.0033 8.99967 10.877C10.2283 9.46508 11.2205 7.81616 11.9095 6.00101L2 6V4H8V2H10ZM17.5 12.8852L16.253 16H18.745L17.5 12.8852Z"
        ></path>
      </svg>
    </button>
    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>
    <script>
      function toggleMenu(e) {
        e?.stopPropagation?.();
        const menu = document.getElementById("mobileMenu");
        const now = menu.style.display === "flex" ? "none" : "flex";
        menu.style.display = now;
        if (now === "flex")
          document.getElementById("searchBelow").classList.remove("open");
      }

      function toggleSearch() {
        const bar = document.getElementById("searchBelow");
        bar.classList.toggle("open");
        const menu = document.getElementById("mobileMenu");
        if (menu.style.display === "flex") menu.style.display = "none";
        if (bar.classList.contains("open")) {
          requestAnimationFrame(() =>
            document.getElementById("globalSearchInput").focus()
          );
        }
      }

      // Highlight active nav link
      document.addEventListener("DOMContentLoaded", function () {
        const path = window.location.pathname.split("/").pop();
        document
          .querySelectorAll(".nav-center a, .mobile-menu a")
          .forEach((link) => {
            if (link.getAttribute("href") === path) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });
      });



      // Submit search to products page
      document.addEventListener("DOMContentLoaded", function () {
        const global = document.getElementById("globalSearchInput");
        if (global) {
          global.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = global.value.trim();
              const url = new URL(window.location.origin + "/products");
              if (q) url.searchParams.set("q", q);
              window.location.href = url.toString();
            }
          });
        }
        const quick = document.getElementById("quickSearchInput");
        if (quick) {
          quick.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const q = quick.value.trim();
              const url = new URL(window.location.origin + "/products");
              if (q) url.searchParams.set("q", q);
              window.location.href = url.toString();
            }
          });
        }
      });

      async function copyToClipboard(textToCopy) {
        try {
          await navigator.clipboard.writeText(textToCopy);
          alert("Text copied to clipboard");
        } catch (err) {
          alert("Failed to copy text: " + err);
        }
      }

      // Cart functionality
      async function addToCart(productId) {
        const button = document.querySelector(
          `[data-product-id="${productId}"]`
        );
        const originalText = button.innerHTML;

        // Show loading state
        button.disabled = true;
        button.innerHTML = '<div class="loading"></div> Adding...';

        try {
          const response = await fetch(`/cart/add/${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            showCartMessage("Product added to cart!", "success");
            // Update cart count
            updateCartCount();
            // Reset button
            button.innerHTML = "âœ“ Added to Cart";
            button.style.background = "#28a745";
            setTimeout(() => {
              button.innerHTML = originalText;
              button.style.background = "";
              button.disabled = false;
            }, 2000);
          } else {
            throw new Error(data.message || "Failed to add to cart");
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          showCartMessage("Failed to add to cart", "error");
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      async function updateCartCount() {
        try {
          const response = await fetch("/api/cart/count");
          const data = await response.json();
          document.getElementById("cartCount").textContent = data.count;
        } catch (error) {
          console.error("Error updating cart count:", error);
        }
      }

      function showCartMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".cart-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        // Create new message
        const messageEl = document.createElement("div");
        messageEl.className = `cart-message ${type}`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        // Show message
        setTimeout(() => messageEl.classList.add("show"), 100);

        // Hide message after 3 seconds
        setTimeout(() => {
          messageEl.classList.remove("show");
          setTimeout(() => messageEl.remove(), 300);
        }, 3000);
      }

      // Update cart count on page load
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
      });

      // Handle sort change
      function handleSortChange(sortValue) {
        const url = new URL(window.location);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
      }
    </script>
    <script src="../static/js/app.js"></script>
    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en", // Set your website's default language
            includedLanguages:
              "en,hi,bi,ta,te,mr,gu,kn,ml,pa,ur,es,fr,de,zh,ja,ko", // Optional: Specify languages to include in the dropdown
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE, // Optional: Customize widget layout
          },
          "google_translate_element"
        );
      }
    </script>
  </body>
</html>
